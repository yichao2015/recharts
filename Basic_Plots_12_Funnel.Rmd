---
title: "Basic Plots 12 - Funnel Chart"
output: 
  html_document: 
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First, you should load `recharts`:
```{r}
library(recharts)
```

# Introduction

Funnel plot includes 2 basic types:

- Funnel
- Pyramid

<table id='intro'>
<tr><td>
```{r,echo=FALSE}
cars <- data.table::dcast(mtcars, carb~am, length, value.var='gear')
cars <- data.table::melt(cars, id='carb')
names(cars) <- c("carb", "am", "N")
echartr(cars, carb, N, type='funnel') %>% 
    setLegend(pos=3) %>%
    setTheme('infographic', width=400, height=300) %>%
    setTitle('mtcars: carb distibution by am','funnel')
```
</td>
<td>
```{r,echo=FALSE}
echartr(cars, carb, N, type='pyramid') %>% 
    setLegend(pos=3) %>%
    setTheme('roma', width=400, height=300) %>%
    setTitle('mtcars: carb distibution by am','pyramid')
```
</td></tr>
</table>

The keys are:

- character `x` and numeric `y` and will be compacted using `data.table::dcast` with `fun=sum`
- **`x` is used as series, while `series` is used to produce separate pies!**
- Pie and funnel charts can shift from one to another by clicking type shift buttons in the toolbox widget.

# Function Call

```r
echartr(data, x, <y>, <series>, <z>, <type>)
```

+--------+--------------------------------------------------------------------+
| Arg    |  Requirement                                                       |
+========+====================================================================+
|**data**| source data in the form of data.frame                            |
+--------+--------------------------------------------------------------------+
| **x**  | character independent variable. Each level of `x` is treated as a data series. Other type will be coerced to factors. Only the first one is accepted if multiple variables are provided. |
+--------+--------------------------------------------------------------------+
| y      | numeric dependent variable. Only the first one is accepted if multiple variables are provided. |
+--------+--------------------------------------------------------------------+
| series | series variable which will be coerced to factors. Each level of `series` is treated as a subsetting factor to produce separate pies. Only the first one is accepted if multiple variables are provided. |
+--------+--------------------------------------------------------------------+
|  z     | timeline variable which will be coerced to factors. Only the first one is accepted if multiple variables are provided. |
+--------+--------------------------------------------------------------------+
| type   | 'funnel', 'pyramid'. |
+--------+--------------------------------------------------------------------+


# Showcase

## Data Preparation

Let's look into `mtcars` dataset embeded in the package `datasets`. The distribution by carb and am is shown as below:

```{r}
cars <- data.table::dcast(mtcars, carb+am~., length, value.var='gear')
names(cars) <- c("carb", "am", "N")
knitr::kable(cars)
```

## Funnel Chart

### Single Funnel

`type` is set 'funnel'.

```{r}
echartr(cars, carb, N, type='funnel') %>% 
    setTitle('mtcars: carb distibution')
```

### Multiple Funnel

Unlike charts under Cartesian coordinate system, funnel chart uses `series` as subsetting factor to produce seperate polar systems. So when we apply `am` (containing 4 levels) as `series`, we get 2 funnels.

```{r}
echartr(cars, carb, N, am, type='funnel') %>% 
    setTitle('mtcars: carb distibution by am')
```

### With Timeline

We need another variable as timeline. Let's say, 'gear'.

```{r}
cars_gear <- data.table::dcast(mtcars, carb+gear+am~., length, value.var='gear')
names(cars_gear) <- c("carb", "gear", "am", "N")
```

In order to make timeline work properly, we need an expand.grid dataset to cover all the combination of `x` and `z` levels.

```{r}
fullData <- with(mtcars, data.frame(
    expand.grid(unique(carb), unique(gear), unique(am))))
names(fullData) <- c("carb", "gear", "am")
cars_gear <- merge(cars_gear, fullData, all.y=TRUE)
```

```{r}
echartr(cars_gear, carb, N, am, z=gear, type='funnel') %>% 
    setTitle('mtcars: carb distibution by am across gear')
```

## Pyramid Chart

`type` is set 'pyramid'.

```{r}
echartr(cars, carb, N, am, type='pyramid') %>% 
    setTitle('mtcars: carb distibution by am')
```

You can also mix `funnel` and `pyramid`.

```{r}
echartr(cars, carb, N, am, type=c('funnel', 'pyramid')) %>% 
    setTitle('mtcars: carb distibution by am')
```


# Futher Setup

Then you can configure the widgets, add markLines and/or markPoints, fortify the chart.

You can refer to related functions to play around on your own.

